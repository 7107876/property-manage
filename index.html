<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物业管理系统</title>
    
    <!-- 国内CDN加速 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.2.36/vue.global.prod.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.3/index.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.3/index.min.css">
    
    <!-- 本地备用资源（放在项目js/目录） -->
    <script>
    if(!window.Vue) {
        document.write('<script src="./js/vue.global.prod.min.js"><\/script>');
        document.write('<script src="./js/element-plus.full.min.js"><\/script>');
        document.write('<link rel="stylesheet" href="./css/element-plus.min.css">');
    }
    </script>

    <style>
    .error-badge {
        position: relative;
    }
    .error-badge::after {
        content: "!";
        position: absolute;
        top: -8px;
        right: -8px;
        background: red;
        color: white;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        text-align: center;
        font-size: 12px;
    }
    </style>
</head>
<body>
    <div id="app">
        <!-- 搜索和统计区域 -->
        <div class="toolbar">
            <el-input 
                v-model="searchText" 
                placeholder="输入项目名称/物业公司搜索"
                clearable
                style="width: 300px; margin-right: 20px;"
            ></el-input>
            
            <el-tag type="info">总项目数：{{ totalItems }}</el-tag>
            <el-tag type="warning" v-if="errorCount > 0">异常数据：{{ errorCount }} 条</el-tag>
        </div>

        <!-- 数据表格 -->
        <el-table 
            :data="paginatedData" 
            border 
            stripe
            v-loading="loading"
            style="margin-top: 20px;"
        >
            <el-table-column 
                v-for="col in tableColumns" 
                :key="col.prop"
                :prop="col.prop" 
                :label="col.label"
                :width="col.width"
                :sortable="col.sortable"
            >
                <template #default="{ row }">
                    <span :class="{ 'error-badge': row[col.prop + '_error'] }">
                        {{ row[col.prop] || '暂无数据' }}
                    </span>
                </template>
            </el-table-column>
        </el-table>

        <!-- 分页控件 -->
        <el-pagination
            v-model:current-page="currentPage"
            :page-sizes="[10, 20, 50]"
            :page-size="pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="totalItems"
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            style="margin-top: 20px;"
        ></el-pagination>

        <!-- 错误提示 -->
        <el-dialog 
            title="数据异常详情" 
            v-model="errorDialogVisible"
            width="70%"
        >
            <el-table :data="errorData">
                <el-table-column prop="project" label="项目名称"></el-table-column>
                <el-table-column prop="field" label="问题字段"></el-table-column>
                <el-table-column prop="message" label="错误描述"></el-table-column>
            </el-table>
        </el-dialog>
    </div>

    <script>
    const App = {
        data() {
            return {
                rawData: [],       // 原始数据
                processedData: [], // 处理后的数据
                searchText: '',    // 搜索关键词
                currentPage: 1,    // 当前页码
                pageSize: 10,      // 每页条数
                errorCount: 0,     // 错误总数
                errorData: [],     // 错误详情
                loading: true,     // 加载状态
                errorDialogVisible: false,
                
                // 表格列配置
                tableColumns: [
                    { prop: 'project_name', label: '项目名称', width: 250, sortable: true },
                    { prop: 'term', label: '任期时间', width: 200 },
                    { prop: 'property_company', label: '物业公司', width: 180 },
                    { prop: 'contact', label: '联系方式' },
                    { prop: 'total_area', label: '建筑面积(㎡)', width: 130, sortable: true }
                ]
            }
        },
        computed: {
            // 过滤后的数据
            filteredData() {
                const search = this.searchText.toLowerCase();
                return this.processedData.filter(item => {
                    return ['project_name', 'property_company'].some(field => 
                        String(item[field]).toLowerCase().includes(search)
                    );
                });
            },
            // 分页数据
            paginatedData() {
                const start = (this.currentPage - 1) * this.pageSize;
                return this.filteredData.slice(start, start + this.pageSize);
            },
            // 总条目数
            totalItems() {
                return this.filteredData.length;
            }
        },
        methods: {
            // 日期格式化（增强版）
            formatDate(raw) {
                try {
                    if (!raw) throw new Error('空值');
                    
                    const [startPart, endPart] = raw.split(/[-—至]/).map(s => s.trim());
                    const parse = (str) => {
                        const cleaned = str.replace(/[年月]/g, '.').replace(/[^\d.]/g, '');
                        const [y, m, d] = cleaned.split('.').map(Number);
                        return new Date(y, m - 1, d || 1);
                    };

                    const startDate = parse(startPart);
                    const endDate = parse(endPart);
                    
                    if (isNaN(startDate) || isNaN(endDate)) {
                        throw new Error('无效日期');
                    }

                    const format = date => `
                        ${date.getFullYear()}.
                        ${String(date.getMonth() + 1).padStart(2, '0')}.
                        ${String(date.getDate()).padStart(2, '0')}
                    `.replace(/\s+/g, '');

                    return `${format(startDate)} 至 ${format(endDate)}`;
                } catch (error) {
                    this.errorCount++;
                    this.errorData.push({
                        project: this.currentItem?.project_name || '未知项目',
                        field: '本届业委会任期起止时间',
                        message: `原始值："${raw}"，错误：${error.message}`
                    });
                    return '日期格式异常';
                }
            },
            // 初始化加载数据
            async loadData() {
                try {
                    const response = await fetch('data.json');
                    if (!response.ok) throw new Error(`HTTP错误 ${response.status}`);
                    
                    const raw = await response.json();
                    this.rawData = Array.isArray(raw) ? raw : [raw];
                    
                    this.processedData = this.rawData.map(item => {
                        this.currentItem = item; // 用于错误追踪
                        return {
                            project_name: item['项目名称'] || '未命名项目',
                            term: this.formatDate(item['本届业委会任期起止时间']),
                            property_company: item['物业企业名称'] || '暂无信息',
                            contact: item['负责人手机'] 
                                ? `${item['项目负责人']} (${item['负责人手机']})`
                                : '暂无联系方式',
                            total_area: item['总建筑面积（㎡）'] 
                                ? Number(item['总建筑面积（㎡）']).toLocaleString()
                                : '—'
                        };
                    });
                } catch (error) {
                    this.$message.error(`数据加载失败：${error.message}`);
                } finally {
                    this.loading = false;
                    this.currentItem = null;
                }
            },
            // 分页事件处理
            handleSizeChange(size) {
                this.pageSize = size;
                this.currentPage = 1;
            },
            handleCurrentChange(page) {
                this.currentPage = page;
            }
        },
        mounted() {
            this.loadData();
        }
    };

    const app = Vue.createApp(App);
    app.use(window.ElementPlus);
    app.mount('#app');
    </script>
</body>
</html>