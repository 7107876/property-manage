<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <style>
        #global-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        #global-loading .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1E88E5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物业管理系统</title>
    
    <!-- 主CDN源 -->
    <script src="https://unpkg.com/vue@3.2.36/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus@2.3.3/dist/index.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.3.3/dist/index.css">
    
    <!-- 备用CDN源 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.2.36/vue.global.prod.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.3/index.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-plus/2.3.3/index.min.css">
    
    <!-- 修改本地资源路径为相对路径 -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('global-loading').style.display = 'none';
    (function initDependencies() {
        // 资源缓存键名
        const CACHE_KEY = 'property-manage-resources-v1';
        
        // 检查并更新缓存
        async function updateCache() {
            try {
                const cache = await caches.open(CACHE_KEY);
                const urls = [
                    'https://unpkg.com/vue@3.2.36/dist/vue.global.prod.js',
                    'https://unpkg.com/element-plus@2.3.3/dist/index.full.min.js',
                    'https://unpkg.com/element-plus@2.3.3/dist/index.css',
                    'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.4/css/all.min.css'
                ];
                await cache.addAll(urls);
                return true;
            } catch (e) {
                console.error('Failed to cache resources:', e);
                return false;
            }
        }
        
        // 从缓存加载资源
        async function loadFromCache(url) {
            try {
                const cache = await caches.open(CACHE_KEY);
                const response = await cache.match(url);
                if (response) {
                    return response;
                }
                window.__showRefreshButton();
                return null;
            } catch (e) {
                console.error('Cache load failed:', e);
                window.__showRefreshButton();
                return null;
            }
        }
        
        const resources = [
            { 
                test: () => !window.Vue,
                urls: [
                    { 
                        type: 'script', 
                        src: 'https://unpkg.com/vue@3.2.36/dist/vue.global.prod.js',
                        fallback: './js/vue.global.prod.min.js'
                    },
                    { 
                        type: 'script', 
                        src: 'https://unpkg.com/element-plus@2.3.3/dist/index.full.min.js',
                        fallback: './js/element-plus.full.min.js'
                    },
                    { 
                        type: 'style', 
                        href: 'https://unpkg.com/element-plus@2.3.3/dist/index.css',
                        fallback: './css/element-plus.min.css'
                    }
                ]
            },
            {
                test: () => !document.fonts.check('1rem "Font Awesome 5 Free"'),
                urls: [
                    { 
                        type: 'style', 
                        href: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.4/css/all.min.css',
                        fallback: '/css/font-awesome.min.css'
                    }
                ]
            }
        ];

        // 初始化缓存
        updateCache();
        
        // 暴露给Vue实例
        window.__updateCache = updateCache;
        window.__showRefreshButton = () => {
            const app = document.querySelector('#app').__vue_app__;
            app._instance.proxy.showRefreshButton = true;
        };
        
        resources.forEach(resource => {
            if (resource.test()) {
                resource.urls.forEach(async ({ type, src, href, fallback }) => {
                    const url = src || href;
                    const cachedResponse = await loadFromCache(url);
                    
                    if (cachedResponse) {
                        if (type === 'script') {
                            const blob = await cachedResponse.blob();
                            const objectURL = URL.createObjectURL(blob);
                            const elem = Object.assign(document.createElement('script'), { 
                                src: objectURL 
                            });
                            document.head.appendChild(elem);
                        } else {
                            const blob = await cachedResponse.blob();
                            const objectURL = URL.createObjectURL(blob);
                            const elem = Object.assign(document.createElement('link'), { 
                                rel: 'stylesheet', 
                                href: objectURL 
                            });
                            document.head.appendChild(elem);
                        }
                    } else {
                        // 缓存未命中，使用备用URL
                        const elem = type === 'script' 
                            ? Object.assign(document.createElement('script'), { src: fallback || src })
                            : Object.assign(document.createElement('link'), { 
                                rel: 'stylesheet', 
                                href: fallback || href 
                            });
                        document.head.appendChild(elem);
                    }
                });
            }
        });
    })();
});
    </script>

    <style>
    [v-cloak] { display: none; }
    :root {
        --primary: #1E88E5;
        --warning: #FFB74D;
        --danger: #E53935;
        --success: #43A047;
        --text-primary: #263238;
        --text-regular: #546E7A;
        --text-secondary: #90A4AE;
        --border-color: #CFD8DC;
        --bg-color: #F5F7FA;
    }

    body {
        font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        background: var(--bg-color);
        margin: 0;
        color: var(--text-primary);
        line-height: 1.6;
    }

    #app {
        max-width: 1600px;
        margin: 20px auto;
        background: #FFFFFF;
        border-radius: 16px;
        box-shadow: 0 4px 24px rgba(30, 136, 229, 0.1);
        padding: 32px;
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
    }

    .toolbar {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .page-title {
        display: flex;
        align-items: center;
        margin-right: 20px;
    }
    
    .page-title h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .page-title .el-icon-office-building {
        font-size: 24px;
        color: var(--primary);
        margin-right: 10px;
    }

    .el-tag {
        font-weight: 500;
        padding: 0 12px;
        height: 32px;
        line-height: 30px;
    }

    .el-table {
        border-radius: 8px;
        border: 1px solid #EBEEF5;
    }

    .el-table th {
        background: #f8f9fa !important;
        font-weight: 600;
        color: #606266;
    }

    .el-table__row:hover td {
        background: #f5f7fa !important;
    }

    .error-badge {
        position: relative;
        padding-right: 20px;
    }
    .error-badge::after {
        content: "!";
        position: absolute;
        top: -8px;
        right: 0;
        background: var(--danger);
        color: white;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        text-align: center;
        font-size: 12px;
        line-height: 18px;
        font-weight: bold;
    }

    .term-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
    
    .ai-notification {
        background: #F8FBFF !important;
        border-left: 4px solid var(--primary) !important;
        box-shadow: 0 4px 12px rgba(30, 136, 229, 0.3) !important;
        border-radius: 12px !important;
        padding: 16px !important;
        width: 320px !important;
        border: 1px solid rgba(30, 136, 229, 0.1) !important;
    }
    .ai-notification .el-notification__title {
        color: var(--primary) !important;
        font-weight: 600;
        margin-bottom: 8px;
    }
    .ai-notification .el-notification__content {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin: 0 !important;
    }
    .ai-avatar {
        width: 40px;
        height: 40px;
        background: var(--primary);
        border-radius: 50%;
        position: relative;
        flex-shrink: 0;
    }
    .ai-mouth {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 16px;
        height: 8px;
        background: white;
        border-radius: 0 0 8px 8px;
        animation: speak 0.5s infinite alternate;
    }
    .ai-message {
        flex: 1;
    }
    .ai-message p {
        margin: 4px 0;
        line-height: 1.5;
    }
    .ai-message ul {
        margin: 8px 0 0 16px;
        padding: 0;
    }
    .ai-message li {
        margin-bottom: 4px;
    }
    @keyframes speak {
        0% { height: 8px; }
        100% { height: 4px; }
    }
    .term-normal {
        background: #00ff00;
    }
    .term-warning {
        background: #ffa500;
    }
    .term-critical {
        background: #ff0000;
    }
    #app .el-tag.term-tag {
        background: inherit !important;
    }

    .star-rating {
        color: var(--warning);
    }
    .star-rating i {
        margin-right: 2px;
    }

    .status-tag {
        min-width: 60px;
        text-align: center;
        font-weight: 500;
    }

    .number-cell {
        font-family: 'Roboto Mono', monospace;
        text-align: right;
    }

    .mobile-hidden {
        display: table-cell;
    }
    @media (max-width: 768px) {
        .mobile-hidden {
            display: none;
        }
        .el-table td,
        .el-table th {
            padding: 8px 0;
        }
        
        /* 重新组织数据可视化区域布局 */
        .chart-section {
            display: flex;
            flex-direction: column;
            margin-top: 30px;
        }
        
        .chart-section h3 {
            font-size: 18px;
            margin: 0 0 15px 0;
            font-weight: 600;
            color: var(--text-primary);
            padding: 0 15px;
        }
        
        .chart-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 0 15px 15px;
        }
        
        /* 图表容器移动端适配 */
        #chart-container {
            height: 350px;
            padding: 15px;
            margin: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
        }
        
        /* 图表选项移动端适配 */
        .echarts-toolbox {
            right: 10px !important;
            top: 10px !important;
        }
        
        /* 饼图标签移动端适配 */
        .echarts-series-name {
            font-size: 12px !important;
            margin: 5px 0 !important;
        }
        
        /* 饼图标签间距调整 */
        .echarts-data-item {
            margin: 8px 0 !important;
        }
        
        /* 字段按钮和饼图分开显示 */
        .toolbar {
            margin-bottom: 30px;
        }
        .chart-section {
            margin-top: 30px;
        }
    }

    .el-dialog__body {
        max-height: 60vh;
        overflow-y: auto;
    }
    .term-indicator {
        width: 8px;
        height: 16px;
        display: inline-block;
        margin-right: 8px;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #1E88E5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .house-icon {
        display: inline-block;
    }
</style>
</head>
<body>
    <div id="global-loading">
        <div class="spinner"></div>
    </div>
    <div id="app" v-cloak>
        <div class="loading-overlay" v-if="loading">
            <div class="loading-spinner"></div>
        </div>
        <div class="toolbar">
            <div class="page-title">
                <svg class="house-icon" style="width:32px;height:32px;margin-right:10px;" viewBox="0 0 24 24">
  <path fill="#1E88E5" d="M12,3L2,12H5V20H19V12H22L12,3M12,7.7C14.1,7.7 15.8,9.4 15.8,11.5C15.8,13.6 14.1,15.3 12,15.3C9.9,15.3 8.2,13.6 8.2,11.5C8.2,9.4 9.9,7.7 12,7.7M7,14V16H17V14H7Z" />
</svg>
                <h2>物业管理系统</h2>
            </div>
            <el-input
                v-model="searchText"
                placeholder="输入任意字段搜索"
                clearable
                style="width: 300px;"
                @keyup.enter="handleSearch"
            >
                <template #prefix>
                    <i class="el-icon-search"></i>
                </template>
            </el-input>
            
            <el-tag type="info" effect="dark">总项目数：{{ totalItems }}</el-tag>
            <el-tag 
                type="danger" 
                effect="dark" 
                v-if="errorCount > 0" 
                @click="errorDialogVisible = true"
                style="cursor: pointer"
            >
                异常数据：{{ errorCount }} 条 <i class="el-icon-warning-outline"></i>
            </el-tag>
            
            <el-button 
                type="primary" 
                @click="refreshCache"
                :loading="cacheLoading"
                v-if="showRefreshButton"
            >
                <i class="el-icon-refresh"></i> 刷新缓存
            </el-button>
        </div>

        <!-- 替换原有的el-table为卡片式布局 -->
        <el-row :gutter="20" class="card-container">
            <el-col 
                v-for="(item, index) in paginatedData" 
                :key="index" 
                :xs="24" 
                :sm="12" 
                :md="8" 
                :lg="6"
                class="card-col"
            >
                <el-card 
                    class="property-card" 
                    :class="{ 'expanded': item.isExpanded }"
                    @click="toggleExpand(item)"
                >
                    <div class="card-header">
                        <h3 class="title">{{ item[Object.keys(item)[0]] }}</h3>
                        <el-tag :type="getTagType(item)">
                            <span :class="getTermClass(item)" class="term-indicator"></span>
                            <span style="color: black">{{ item.remainingDays !== null ? `剩余${item.remainingDays}天` : '无' }}</span>
                        </el-tag>
                    </div>

                    <div class="card-content">
                        <div class="info-item" v-for="col in mainColumns" :key="col.prop">
                            <label>{{ col.label }}：</label>
                            <span v-html="formatCardValue(col, item)"></span>
                        </div>
                    </div>

                    <!-- 展开后的详细信息 -->
                    <div class="expanded-details" v-if="item.isExpanded">
                        <div class="detail-section" v-for="col in detailColumns" :key="col.prop">
                            <h4>{{ col.label }}</h4>
                            <div v-html="formatCardValue(col, item)"></div>
                        </div>
                    </div>
                </el-card>
            </el-col>
        </el-row>

        <!-- 保留原有分页代码 -->
        <el-pagination
            v-model:current-page="currentPage"
            :page-sizes="[10, 20, 50]"
            :page-size="pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="totalItems"
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            style="margin-top: 20px;"
            class="pagination-container"
        ></el-pagination>

        <el-dialog
            title="数据异常详情"
            v-model="errorDialogVisible"
            width="70%"
        >
            <el-table :data="errorData" border>
                <el-table-column prop="project" label="项目名称" width="200"></el-table-column>
                <el-table-column prop="field" label="问题字段"></el-table-column>
                <el-table-column prop="message" label="错误描述" width="400"></el-table-column>
            </el-table>
        </el-dialog>
        
        <div class="chart-section">
            <h3 style="margin: 20px 0 10px;">数据可视化面板</h3>
            <div id="chart-container" style="width: 100%; height: 400px;"></div>
        </div>
    </div>
    
    <!-- ECharts主CDN源 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js" onerror="loadFallbackECharts()"></script>
    <!-- ECharts备用CDN源 -->
    <script id="fallback-echarts" src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js" style="display:none"></script>
    <script>
      function loadFallbackECharts() {
        console.log('主CDN加载失败，尝试使用备用CDN');
        document.getElementById('fallback-echarts').style.display = 'block';
      }
    </script>
    <script>
        // 图表配置存储键名
        const CHART_CONFIG_KEY = 'property-chart-config';
        
        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function() {
                clearTimeout(timeout);
                timeout = setTimeout(func, wait);
            };
        }
        
        // 验证数据格式
        function validateData(data) {
            if (!Array.isArray(data)) {
                throw new Error('数据格式错误：应为数组');
            }
            if (data.length === 0) {
                throw new Error('数据为空');
            }
            if (!data[0] || typeof data[0] !== 'object') {
                throw new Error('数据项格式错误：应为对象');
            }
            return true;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // 检查ECharts是否加载成功
            function checkECharts() {
                if (typeof echarts === 'undefined') {
                    console.error('ECharts加载失败：全局echarts对象未定义');
                    alert('图表库加载失败，请检查网络连接或刷新页面');
                    return false;
                }
                return true;
            }
            

            // 初始化图表
            function initChart() {
                if (!checkECharts()) return;
                
                const chartDom = document.getElementById('chart-container');
                if (!chartDom) {
                    console.error('图表容器未找到：元素#chart-container不存在');
                    return;
                }
                
                const myChart = echarts.init(chartDom);
                
                // 显示加载状态
                myChart.showLoading();
                
                // 加载数据
                fetch('./data.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`网络请求失败: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        validateData(data);
                        
                        // 分析数据字段
                        const fields = Object.keys(data[0]);
                        
                        // 生成系列数据
                        const series = fields.map(field => {
                            // 去除字段名中的冒号及后面内容
                            const displayName = field.includes(':') ? field.split(':')[0] : field;
                            // 数值类型字段直接显示值
                            if (typeof data[0][field] === 'number') {
                                return {
                                    name: displayName,
                                    type: 'bar',
                                    data: data.map(item => item[field])
                                };
                            }
                            
                            // 文本类型字段统计出现频率
                            const valueMap = {};
                            data.forEach(item => {
                                const value = item[field];
                                valueMap[value] = (valueMap[value] || 0) + 1;
                            });
                            
                            return {
                                name: displayName,
                                type: 'bar',
                                data: Object.entries(valueMap).map(([name, value]) => ({
                                    name,
                                    value
                                }))
                            };
                        });
                        
                        // 从本地存储加载图表配置
                        const savedConfig = localStorage.getItem(CHART_CONFIG_KEY);
                        const baseOption = {
                            title: {
                                text: '物业数据统计',
                                left: 'center'
                            },
                            tooltip: {
                                trigger: 'item',
                                formatter: '{a} <br/>{b}: {c} ({d}%)'
                            },
                            legend: {
                                orient: 'vertical',
                                left: 10,
                                data: series.map(s => s.name)
                            },
                            toolbox: {
                                feature: {
                                    dataView: { show: true, readOnly: false },
                                    magicType: { 
                                        show: true, 
                                        type: ['pie', 'funnel'] 
                                    },
                                    restore: { show: true },
                                    saveAsImage: { show: true }
                                }
                            }
                        };
                        
                        // 合并保存的配置
                        const option = savedConfig 
                            ? { ...baseOption, ...JSON.parse(savedConfig) }
                            : baseOption;
                        
                        // 添加系列配置
                        option.series = series.map(s => ({
                            name: s.name,
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            itemStyle: {
                                borderRadius: 10,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: true,
                                formatter: '{b}: {c} ({d}%)'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: '18',
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: true
                            },
                            data: s.data
                        }));
                        
                        // 保存配置变更
                        myChart.on('restore', function() {
                            localStorage.setItem(CHART_CONFIG_KEY, JSON.stringify(option));
                        });
                        
                        myChart.hideLoading();
                        myChart.setOption(option);
                        
                        // 响应式调整 - 添加防抖
                        const resizeHandler = debounce(function() {
                            myChart.resize();
                        }, 300);
                        window.addEventListener('resize', resizeHandler);
                        
                        // 保存配置到本地存储
                        localStorage.setItem(CHART_CONFIG_KEY, JSON.stringify(option));
                    })
                    .catch(error => {
                        console.error('加载数据失败:', error);
                        myChart.hideLoading();
                        myChart.setOption({
                            title: {
                                text: '数据加载失败',
                                subtext: error.message,
                                left: 'center',
                                top: 'center'
                            }
                        });
                    });
            }
            
            // 延迟初始化以确保DOM完全加载
            setTimeout(initChart, 100);
        });
    </script>

    <script>
    const App = {
        data() {
            return {
                showRefreshButton: false,
                cacheLoading: false,
                // 动态生成属性列表
                mainColumns: [],
                detailColumns: [],
                
                // 在loadData方法中添加动态生成逻辑
                generateColumns() {
                    if (this.rawData.length === 0) return;
                    
                    const allProps = Object.keys(this.rawData[0]).filter(
                        prop => !prop.endsWith(':J')
                    );
                    
                    // 排除第一个字段
                    const firstProp = allProps[0];
                    const filteredProps = allProps.filter(prop => prop !== firstProp);
                    
                    this.mainColumns = filteredProps
                        .filter(prop => !prop.endsWith(':X'))
                        .map(prop => ({
                            prop,
                            label: prop,
                            formatter: (row, col, cellValue) => `${cellValue || '—'}`
                        }));
                    
                    this.detailColumns = filteredProps
                        .filter(prop => prop.endsWith(':X'))
                        .map(prop => ({
                            prop,
                            label: prop.replace(':X', ''),
                            formatter: (row, col, cellValue) => `${cellValue || '—'}`
                        }));
                },
                rawData: [],
                processedData: [],
                searchText: '',
                currentPage: 1,
                pageSize: 10,
                errorCount: 0,
                errorData: [],
                loading: true,
                errorDialogVisible: false,
                tableColumns: [
                    { prop: '序号', label: 'ID', width: 80, sortable: true },
                    { prop: '星级', label: '星级', width: 130 },
                    { prop: '项目名称', label: '项目名称', width: 250, sortable: true },
                    { prop: 'term', label: '业委会任期', width: 220 },
                    { prop: '详细地址', label: '地址', width: 220 },
                    { prop: '项目性质', label: '类型', width: 120 },
                    { prop: '总建筑面积（㎡）', label: '建筑面积', width: 130, sortable: true },
                    { prop: '总户数', label: '户数', width: 100 },
                    { prop: '物业企业名称', label: '物业公司', width: 180 },
                    { prop: 'contact', label: '负责人', width: 180 },
                    { prop: '是否设立', label: '业委会', width: 100 },
                    { prop: '是否在有效期内', label: '有效期', width: 100 },
                    { prop: '业委会届数', label: '届数', width: 100 },
                    { prop: '小区房屋是否归集维修资金', label: '维修资金', width: 120 }
                ]
            }
        },
        computed: {
            filteredData() {
                const search = this.searchText.toLowerCase();
                return this.processedData.filter(item => {
                    return Object.keys(item).some(key => 
                        String(item[key]).toLowerCase().includes(search)
                    );
                });
            },
            paginatedData() {
                const start = (this.currentPage - 1) * this.pageSize;
                return this.filteredData.slice(start, start + this.pageSize);
            },
            totalItems() {
                return this.filteredData.length;
            }
        },
        methods: {
            async refreshCache() {
                this.cacheLoading = true;
                try {
                    const success = await window.__updateCache();
                    if (success) {
                        this.$message.success('缓存更新成功，即将刷新页面');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        this.$message.error('缓存更新失败');
                    }
                } finally {
                    this.cacheLoading = false;
                }
            },
            getTermClass(row) {
                const dateField = Object.keys(row).find(key => key.endsWith(':J'));
                if (!dateField || row.remainingDays === null) return 'term-critical';
                if (row.remainingDays <= 90) return 'term-critical';
                if (row.remainingDays <= 365) return 'term-warning';
                return 'term-normal';
            },

            // 确保el-tag正确使用term class
            getTagType(row) {
                const termClass = this.getTermClass(row);
                return termClass.replace('term-', '');
            },

            formatDate(raw) {
                try {
                    // 增强输入验证
                    if (!raw || typeof raw !== 'string') return { formatted: '—', remainingDays: null };
                    if (raw === '无业委会' || raw.trim() === '') return { formatted: '—', remainingDays: null };
                    
                    // 标准化分隔符
                    const normalized = raw.replace(/[—]/g, '-').replace(/[至]/g, '-');
                    const parts = normalized.split('-').map(s => s.trim());
                    
                    // 验证日期部分数量
                    if (parts.length < 2) throw new Error('日期格式错误: 缺少结束日期');
                    
                    const parseDate = (str) => {
                        // 增强日期解析验证
                        if (!str || typeof str !== 'string') throw new Error('无效的日期字符串');
                        
                        const cleaned = str.replace(/[年月]/g, '.').replace(/[^\d.]/g, '');
                        const dateParts = cleaned.split('.').filter(Boolean);
                        
                        // 验证日期组成部分
                        if (dateParts.length < 2) throw new Error('日期格式错误: 缺少月份');
                        
                        const y = parseInt(dateParts[0]);
                        const m = parseInt(dateParts[1]);
                        const d = dateParts.length > 2 ? parseInt(dateParts[2]) : 1;
                        
                        // 验证日期有效性
                        if (isNaN(y) || y < 1900 || y > 2100) throw new Error('无效的年份');
                        if (isNaN(m) || m < 1 || m > 12) throw new Error('无效的月份');
                        if (isNaN(d) || d < 1 || d > 31) throw new Error('无效的日期');
                        
                        return new Date(y, m - 1, d);
                    };

                    const startDate = parseDate(parts[0]);
                    const endDate = parseDate(parts[1]);
                    
                    // 验证日期范围
                    if (startDate > endDate) throw new Error('开始日期不能晚于结束日期');
                    
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const diffTime = endDate - today;
                    const remainingDays = Math.floor(diffTime / 86400000);
                    
                    // 添加日期范围限制
                    const maxDays = 365 * 10; // 10年
                    if (remainingDays > maxDays) throw new Error('日期范围过大');

                    const format = date => date.toISOString().split('T')[0].replace(/-/g, '.');
                    return {
                        formatted: `${format(startDate)} 至 ${format(endDate)}`,
                        remainingDays: remainingDays
                    };
                } catch (error) {
                    this.errorCount++;
                    console.error('日期解析错误:', error.message);
                    this.showNotification('数据加载失败，请稍后重试', 'error');
                    return { formatted: '日期异常', remainingDays: null };
                }
            },
            
            findDateField(item) {
                return Object.keys(item).find(key => key.endsWith(':J')) || null;
            },
            
            processDateField(item) {
                const dateField = this.findDateField(item);
                if (!dateField) return { formatted: '—', remainingDays: null };
                
                this.currentItem = item;
                const result = this.formatDate(item[dateField]);
                
                if (result.formatted === '日期异常') {
                    this.errorData.push({
                        project: item.项目名称 || '未知项目',
                        field: dateField,
                        message: `原始值："${item[dateField]}"，错误：日期解析失败`
                    });
                    console.error('数据异常:', item.项目名称, dateField, item[dateField]);
                    this.showNotification('数据加载失败，请稍后重试', 'error');
                }
                
                return result;
            },

            // 新增切换方法
            toggleExpand(item) {
                // 直接修改属性确保响应式更新
                item.isExpanded = !item.isExpanded;
                
                // 仅更新当前卡片而不是整个列表
                const index = this.processedData.findIndex(i => i === item);
                if (index !== -1) {
                    this.processedData.splice(index, 1, {...item});
                }
            },
            
            formatCardValue(col, item) {
                const value = item[col.prop];
                return value !== null && value !== undefined && value !== '' ? value : '—';
            },

            async loadData() {
                // 显示加载动画
                this.loading = true;
                
                const maxRetries = 8;
                let retryCount = 0;
                let lastError = null;
                
                // 立即检查缓存并显示
                const cachedData = localStorage.getItem('propertyData');
                if (cachedData) {
                    try {
                        const parsed = JSON.parse(cachedData);
                        if (parsed.data && parsed.timestamp) {
                            this.rawData = parsed.data;
                            this.processData();
                        }
                    } catch (e) {
                        console.error('缓存解析错误:', e);
                    }
                }
                
                while (retryCount < maxRetries) {
                    try {
                        // 添加加载状态
                        this.loading = true;
                        
                        // 添加超时处理
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000); // 延长超时时间到10秒
                        
                        // 检查本地缓存
                        if (cachedData) {
                            try {
                                const parsedData = JSON.parse(cachedData);
                                if (parsedData && parsedData.expiry > Date.now()) {
                                    this.rawData = parsedData.data;
                                    this.processData();
                                    return;
                                }
                            } catch (e) {
                                console.error('缓存解析错误:', e);
                            }
                        }
                        
                        // 添加时间戳参数避免缓存
                        const timestamp = new Date().getTime();
                        const response = await fetch(`data.json?t=${timestamp}`, {
                            signal: controller.signal,
                            cache: 'no-cache',
    headers: {
        'Cache-Control': 'no-cache'
    }
});

// 如果数据为空，显示空状态
if (!response.ok || !response.body) {
    this.showNotification('数据加载失败，请稍后重试', 'error');
    return;
}
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) throw new Error(`加载失败: ${response.status}`);
                        
                        // 验证数据完整性
                        const data = await response.json();
                        if (!Array.isArray(data)) throw new Error('数据格式错误: 期望数组');
                        if (data.length === 0) throw new Error('数据为空');
                        
                        this.rawData = data;
                    
                    // 保存到本地缓存并添加版本标识
                    try {
                        const cacheData = {
                            data: data,
                            version: new Date().getTime()
                        };
                        localStorage.setItem('propertyData', JSON.stringify(cacheData));
                    } catch (e) {
                        console.warn('本地存储失败:', e);
                    }
                    
                    // 添加isExpanded字段
                    this.processedData = this.rawData.map(item => {
                        const termResult = this.processDateField(item);
                        
                        return {
                            ...item,
                            isExpanded: false,
                            term: termResult.formatted,
                            remainingDays: termResult.remainingDays,
                            contact: item.负责人手机 
                                ? `${item.项目负责人}\n${item.负责人手机}` 
                                : item.项目负责人 || '—',
                            '总建筑面积（㎡）': Number(item['总建筑面积（㎡）']) || 0,
                            '总户数': Number(item.总户数) || 0,
                            '业委会届数': Number(item.业委会届数) || 0
                        };
                    });
                    
                    this.generateColumns();
                    
                    // 在数据处理完成后执行预警检查
                    const warningItems = this.processedData.filter(item => 
                        item.remainingDays !== null && item.remainingDays < 365
                    );
                    
                    if (warningItems.length > 0) {
                        this.$notify({
                            customClass: 'ai-notification',
                            title: '系统助手提醒',
                            type: 'warning',
                            dangerouslyUseHTMLString: true,
                            message: `
                                <div class="ai-avatar">
                                    <div class="ai-mouth"></div>
                                </div>
                                <div class="ai-message">
                                    <p>欢迎使用物业管理系统！本系统帮助您跟踪和管理物业项目信息。</p>
                            <p>当前发现<b>${warningItems.length}</b>个项目任期剩余不足1年：</p>
                                    <ul>
                                        ${warningItems.slice(0,5).map(i => 
                                            `<li>${i[Object.keys(i)[0]]}（剩余${i.remainingDays}天）</li>`
                                        ).join('')}
                                    </ul>
                                    ${warningItems.length > 5 ? '<p>等更多...</p>' : ''}
                                </div>
                            `,
                            duration: 0,
                            position: 'bottom-right',
                            offset: 40
                        });
                    } else if (this.errorData.length === 0) {
                        this.$notify({
                            customClass: 'ai-notification',
                            title: '系统助手提醒',
                            type: 'success',
                            dangerouslyUseHTMLString: true,
                            message: `
                                <div class="ai-avatar">
                                    <div class="ai-mouth"></div>
                                </div>
                                <div class="ai-message">
                                    <p>欢迎使用物业管理系统！本系统帮助您跟踪和管理物业项目信息。</p>
                                    <p>当前所有项目运行良好。</p>
                                </div>
                            `,
                            duration: 3000,
                            position: 'bottom-right',
                            offset: 40
                        });
                    }
                    
                                        break; // 成功则退出重试循环
                    } catch (error) {
                        lastError = error;
                        retryCount++;
                        
                        // 重试前等待
                        if (retryCount < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                        }
                    }
                }
                
                if (retryCount === maxRetries && lastError) {
                    this.$message.error(`数据加载失败(重试${maxRetries}次): ${lastError.message}`);
                    this.showEmptyState();
                }
                
                this.loading = false;
                this.currentItem = null;
                this.generateColumns();
                
                // 隐藏加载动画
            },

            handleSizeChange(size) {
                this.pageSize = size;
                this.currentPage = 1;
            },
            handleCurrentChange(page) {
                this.currentPage = page;
                window.scrollTo(0, 0);
            }
        },
        mounted() {
            this.loadData();
        }
    };

    // 安全初始化逻辑
    function initializeApp() {
        if (!window.Vue || !window.ElementPlus) {
            document.body.innerHTML = `
                <div style="padding:20px;color:red">
                    <h3>系统初始化失败</h3>
                    <p>请检查网络连接并刷新页面，或联系技术支持</p>
                </div>
            `;
            return;
        }

        const app = Vue.createApp(App);
        app.use(ElementPlus);
        app.mount('#app');
    }

    // 全局错误处理器
    window.addEventListener('error', (event) => {
        console.error('全局错误捕获:', event.error);
        
        // 可以在这里添加错误上报逻辑
        // fetch('/api/error-report', {
        //     method: 'POST',
        //     body: JSON.stringify({
        //         message: event.error.message,
        //         stack: event.error.stack,
        //         timestamp: new Date().toISOString()
        //     })
        // });
        
        // 显示友好的错误提示
        if (window.Vue && window.ElementPlus) {
            const app = Vue.createApp({
                template: `
                    <div style="padding:20px;color:var(--danger)">
                        <h3>系统发生错误</h3>
                        <p>${event.error.message}</p>
                        <p>请刷新页面或联系技术支持</p>
                    </div>
                `
            });
            app.use(ElementPlus);
            app.mount('#app');
        }
    });
    
    // 延迟初始化确保资源加载
    if (document.readyState === 'complete') {
        initializeApp();
    } else {
        window.addEventListener('DOMContentLoaded', initializeApp);
    }
    </script>
</body>
</html>

<!-- 添加权限策略 -->
<meta http-equiv="Permissions-Policy" content="accelerometer=()">



<style>
.card-container {
    margin-bottom: 20px;
}
.card-col {
    margin-bottom: 20px;
    transition: transform 0.3s;
}
.card-col:hover {
    transform: translateY(-5px);
}
.property-card {
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    min-height: 200px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 8px rgba(30, 136, 229, 0.08);
    background: #FFFFFF;
}
.property-card:hover {
    box-shadow: 0 4px 12px rgba(30, 136, 229, 0.15);
    border-color: var(--primary);
}
.property-card.expanded {
    position: relative;
    z-index: 2;
    box-shadow: 0 8px 24px rgba(30, 136, 229, 0.2);
    transform: scale(1.02);
    border-color: var(--primary);
}
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px dashed var(--border-color);
}
.card-header .title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
    letter-spacing: 0.5px;
}
.card-content .info-item {
    margin: 12px 0;
    display: flex;
    justify-content: space-between;
}
.card-content .info-item label {
    color: var(--text-secondary);
    font-size: 14px;
}
.card-content .info-item span {
    color: var(--text-regular);
    font-weight: 500;
    text-align: right;
}
.expanded-details {
    margin-top: 8px;
    border-top: 1px solid var(--border-color);
    padding-top: 8px;
}
.detail-section {
    display: flex;
    align-items: flex-start;
    margin: 6px 0;
    line-height: 1.4;
    padding: 4px 0;
    border-bottom: 1px dashed rgba(207, 216, 220, 0.5);
}
.detail-section h4 {
    color: var(--primary);
    margin: 0 12px 0 0;
    font-size: 14px;
    font-weight: 500;
    min-width: 100px;
}
.detail-section > div {
    text-align: right;
    flex: 1;
    font-size: 14px;
    padding-right: 8px;
    word-break: break-word;
}
</style>

<style>
.toolbar {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    padding: 16px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.pagination-container {
    margin-top: 24px;
    padding: 16px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

@media (max-width: 768px) {
    .pagination-container .el-pagination__number {
        display: none;
    }
    .pagination-container .el-pagination__sizes {
        display: none;
    }
    .pagination-container .el-pagination__total {
        display: none;
    }
    .pagination-container .el-pagination__jump {
        display: none;
    }
    .pagination-container .el-pagination__prev,
    .pagination-container .el-pagination__next {
        font-size: 14px;
        padding: 0 8px;
    }
    .pagination-container .el-pagination__prev {
        margin-right: 10px;
    }
    .pagination-container .el-pagination__next {
        margin-left: 10px;
    }
    .pagination-container {
        overflow-x: auto;
    }
}

.el-tag {
    font-weight: 500;
    padding: 0 12px;
    height: 32px;
    line-height: 30px;
    border-radius: 6px;
}
</style>

<style>
/* 卡片入场动画 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-col {
    animation: fadeInUp 0.5s ease forwards;
    opacity: 0;
}

/* 为不同列添加延迟动画 */
.card-col:nth-child(1) { animation-delay: 0.1s; }
.card-col:nth-child(2) { animation-delay: 0.2s; }
.card-col:nth-child(3) { animation-delay: 0.3s; }
.card-col:nth-child(4) { animation-delay: 0.4s; }
/* 可以根据需要添加更多 */
</style>